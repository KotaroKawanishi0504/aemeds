export default class Megamenu{constructor(e,t){e&&(this.rootElement=e,this.defaults={animation:{duration:300,easing:"ease"},delay:300,selector:{background:".l-header__background",link:".l-header__navigation-item > a",trigger:".l-header__navigation-item > button, button.l-header__search",submenu:".l-header__navigation-sub"}},this.settings={...this.defaults,...t,selector:{...this.defaults.selector,...t?.selector},animation:{...this.defaults.animation,...t?.animation}},window.matchMedia("(prefers-reduced-motion: reduce)").matches&&(this.settings.animation.duration=0),this.linkElements=[...this.rootElement.querySelectorAll(this.settings.selector.link)],this.triggerElements=[...this.rootElement.querySelectorAll(this.settings.selector.trigger)],this.submenuElements=[...this.rootElement.querySelectorAll(this.settings.selector.submenu)],this.backgroundElement=this.rootElement.querySelector(this.settings.selector.background),this.animations=Array(this.triggerElements.length).fill(null),this.submenuTimer=0,this.desktopController=null,this.handleWindowPointerMove=this.handleWindowPointerMove.bind(this),this.handleWindowResize=this.handleWindowResize.bind(this),this.handleRootFocusOut=this.handleRootFocusOut.bind(this),this.handleLinkPointerEnter=this.handleLinkPointerEnter.bind(this),this.handleLinkPointerLeave=this.handleLinkPointerLeave.bind(this),this.handleTriggerClick=this.handleTriggerClick.bind(this),this.handleTriggerKeyDown=this.handleTriggerKeyDown.bind(this),this.handleSubmenuBeforeMatch=this.handleSubmenuBeforeMatch.bind(this),this.handleSubmenuKeyDown=this.handleSubmenuKeyDown.bind(this),this.handleSubmenuPointerEnter=this.handleSubmenuPointerEnter.bind(this),this.handleSubmenuPointerLeave=this.handleSubmenuPointerLeave.bind(this),this.initialize())}initialize(){if(!this.linkElements.length||!this.triggerElements.length||!this.submenuElements.length)return;window.addEventListener("resize",this.handleWindowResize),this.rootElement.addEventListener("focusout",this.handleRootFocusOut),this.triggerElements.forEach((e,t)=>{const i=Math.random().toString(36).slice(-8);e.setAttribute("aria-controls",this.submenuElements[t].id||=`megamenu-submenu-${i}`),e.hasAttribute("aria-expanded")||e.setAttribute("aria-expanded","false"),e.id||=`megamenu-trigger-${i}`,e.tabIndex=this.isFocusable(e)?0:-1,this.isFocusable(e)||e.style.setProperty("pointer-events","none"),e.addEventListener("click",this.handleTriggerClick),e.addEventListener("keydown",this.handleTriggerKeyDown)}),this.submenuElements.forEach((e,t)=>{e.setAttribute("aria-labelledby",`${e.getAttribute("aria-labelledby")||""} ${this.triggerElements[t].id}`.trim()),e.role="region",e.addEventListener("beforematch",this.handleSubmenuBeforeMatch),e.addEventListener("keydown",this.handleSubmenuKeyDown)});const e=window.matchMedia("(width >= 900px)");e.addEventListener("change",e=>this.update(e.matches)),this.update(e.matches),this.rootElement.setAttribute("data-megamenu-initialized","")}getActiveElement(){let e=document.activeElement;for(;e instanceof HTMLElement&&e.shadowRoot?.activeElement;)e=e.shadowRoot.activeElement;return e instanceof HTMLElement?e:null}isFocusable(e){return"true"!==e.getAttribute("aria-disabled")&&!e.hasAttribute("disabled")}toggle(e,t,i=!1){if(t.toString()===e.getAttribute("aria-expanded"))return;const n=this.rootElement.querySelector('[aria-expanded="true"]');t&&n&&n!==e&&this.close(n),window.requestAnimationFrame(()=>{e.setAttribute("aria-expanded",String(t))}),e.setAttribute("aria-label",e.getAttribute(`data-megamenu-${t?"expanded":"collapsed"}-label`)??e.getAttribute("aria-label"));const s=this.rootElement.querySelector(`#${e.getAttribute("aria-controls")}`),r=window.getComputedStyle(s),o=`${parseInt(r.getPropertyValue("block-size"))||0}px`,a=this.triggerElements.indexOf(e);let l=this.animations[a];l&&l.cancel(),"none"===r.getPropertyValue("display")&&s.style.setProperty("display","block"),s.removeAttribute("hidden"),s.style.setProperty("overflow","clip"),l=this.animations[a]=s.animate({blockSize:[o,`${t?parseInt(r.getPropertyValue("block-size")):0}px`]},{duration:i||this.desktopController?0:this.settings.animation.duration,easing:this.settings.animation.easing}),this.backgroundElement.style.setProperty("height",t?`${s.scrollHeight}px`:"0"),l.addEventListener("finish",()=>{this.animations[a]=null,t||s.setAttribute("hidden","until-found"),["block-size","display","overflow"].forEach(e=>s.style.removeProperty(e))})}update(e){if(this.desktopController&&(this.desktopController.abort(),this.desktopController=null),!e)return;this.desktopController=new AbortController;const{signal:t}=this.desktopController;window.addEventListener("pointermove",this.handleWindowPointerMove,{once:!0,signal:t}),this.linkElements.forEach(e=>{e.addEventListener("pointerleave",this.handleLinkPointerLeave,{signal:t})}),this.submenuElements.forEach(e=>{e.addEventListener("pointerenter",this.handleSubmenuPointerEnter,{signal:t}),e.addEventListener("pointerleave",this.handleSubmenuPointerLeave,{signal:t})})}handleWindowPointerMove(){const{signal:e}=this.desktopController;this.linkElements.forEach(t=>t.addEventListener("pointerenter",this.handleLinkPointerEnter,{signal:e}))}handleWindowResize(){window.setTimeout(()=>{this.backgroundElement.style.setProperty("height",`${Math.max(...this.submenuElements.map(e=>e.scrollHeight))}px`)})}handleRootFocusOut(e){this.desktopController&&!this.rootElement.contains(e.relatedTarget)&&this.triggerElements.forEach(e=>this.close(e))}handleLinkPointerEnter(e){window.clearTimeout(this.submenuTimer);const t=this.triggerElements[this.linkElements.indexOf(e.currentTarget)];this.submenuTimer=window.setTimeout(()=>{this.open(t)},this.settings.delay)}handleLinkPointerLeave(e){window.clearTimeout(this.submenuTimer);const t=this.triggerElements[this.linkElements.indexOf(e.currentTarget)];this.submenuTimer=window.setTimeout(()=>{this.close(t)},this.settings.delay)}handleTriggerClick(e){e.preventDefault(),e.stopPropagation();const t=e.currentTarget;this.toggle(t,"false"===t.getAttribute("aria-expanded"))}handleTriggerKeyDown(e){const{key:t}=e;if(!["Enter"," ","Escape"].includes(t))return;e.preventDefault(),e.stopPropagation();const i=this.getActiveElement(),n=i instanceof HTMLElement?i:null;if(n)switch(t){case"Enter":case" ":return void n.click();case"Escape":this.close(n)}}handleSubmenuBeforeMatch(e){const t=this.rootElement.querySelector(`[aria-controls="${e.currentTarget.id}"]`);"true"!==t.getAttribute("aria-expanded")&&this.toggle(t,!0,!0)}handleSubmenuKeyDown(e){const{key:t}=e;if("Escape"!==t)return;e.preventDefault(),e.stopPropagation();const i=this.rootElement.querySelector(`[aria-controls="${e.currentTarget.id}"]`);this.close(i),i.focus()}handleSubmenuPointerEnter(){window.clearTimeout(this.submenuTimer)}handleSubmenuPointerLeave(){window.clearTimeout(this.submenuTimer),this.submenuTimer=window.setTimeout(()=>{this.triggerElements.forEach(e=>this.close(e))},this.settings.delay)}open(e){this.triggerElements.includes(e)&&this.toggle(e,!0)}close(e){this.triggerElements.includes(e)&&this.toggle(e,!1)}}