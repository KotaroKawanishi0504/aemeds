export default class Accordion{constructor(t,e){if(!t)return;this.rootElement=t,this.defaults={animation:{duration:300,easing:"ease"},selector:{content:":has(> [data-accordion-trigger]) + *",trigger:"[data-accordion-trigger]"}},this.settings={animation:{...this.defaults.animation,...e?.animation},selector:{...this.defaults.selector,...e?.selector}},window.matchMedia("(prefers-reduced-motion: reduce)").matches&&(this.settings.animation.duration=0);const i=`:not(:scope ${this.settings.selector.content} *)`;this.triggerElements=[...this.rootElement.querySelectorAll(`${this.settings.selector.trigger}${i}`)],this.contentElements=[...this.rootElement.querySelectorAll(`${this.settings.selector.content}${i}`)],this.animations=Array(this.triggerElements.length).fill(null),this.eventController=new AbortController,this.destroyed=!1,this.handleTriggerClick=this.handleTriggerClick.bind(this),this.handleTriggerKeyDown=this.handleTriggerKeyDown.bind(this),this.handleContentBeforeMatch=this.handleContentBeforeMatch.bind(this),this.initialize()}initialize(){if(!this.triggerElements.length||!this.contentElements.length)return;const{signal:t}=this.eventController;this.triggerElements.forEach((e,i)=>{const n=Math.random().toString(36).slice(-8);e.setAttribute("aria-controls",this.contentElements[i].id||=`accordion-content-${n}`),e.hasAttribute("aria-expanded")||e.setAttribute("aria-expanded","false"),e.id||=`accordion-trigger-${n}`,e.setAttribute("tabindex",this.isFocusable(e)?"0":"-1"),this.isFocusable(e)||e.style.setProperty("pointer-events","none"),e.addEventListener("click",this.handleTriggerClick,{signal:t}),e.addEventListener("keydown",this.handleTriggerKeyDown,{signal:t})}),this.contentElements.forEach((e,i)=>{e.setAttribute("aria-labelledby",`${e.getAttribute("aria-labelledby")||""} ${this.triggerElements[i].id}`.trim()),e.setAttribute("role","region"),e.addEventListener("beforematch",this.handleContentBeforeMatch,{signal:t})}),this.rootElement.setAttribute("data-accordion-initialized","")}getActiveElement(){let t=document.activeElement;for(;t instanceof HTMLElement&&t.shadowRoot?.activeElement;)t=t.shadowRoot.activeElement;return t instanceof HTMLElement?t:null}isFocusable(t){return"true"!==t.getAttribute("aria-disabled")&&!t.hasAttribute("disabled")}toggle(t,e,i=!1){if(e.toString()===t.getAttribute("aria-expanded"))return;const n=t.getAttribute("data-accordion-name");if(n){const r=this.rootElement.querySelector(`[aria-expanded="true"][data-accordion-name="${n}"]`);e&&r&&r!==t&&this.toggle(r,!1,i)}t.setAttribute("aria-label",t.getAttribute(`data-accordion-${e?"expanded":"collapsed"}-label`)??(t.getAttribute("aria-label")||""));const r=this.triggerElements.indexOf(t),s=this.contentElements[r],a=window.getComputedStyle(s),o=s.hidden?"0":a.getPropertyValue("block-size");let l=this.animations[r];l?.cancel(),s.hidden=!1;const c=e?parseFloat(a.getPropertyValue("block-size")):0;window.requestAnimationFrame(()=>{t.setAttribute("aria-expanded",String(e))}),s.style.setProperty("overflow","clip"),l=this.animations[r]=s.animate({blockSize:[o,`${Math.max(parseFloat(a.getPropertyValue("min-block-size")),Math.min(c,parseFloat(a.getPropertyValue("max-block-size"))||c))}px`]},{duration:i?0:this.settings.animation.duration,easing:this.settings.animation.easing}),l.addEventListener("finish",()=>{this.animations[r]=null,e||s.setAttribute("hidden","until-found"),["block-size","overflow"].forEach(t=>s.style.removeProperty(t))})}handleTriggerClick(t){t.preventDefault(),t.stopPropagation();const e=t.currentTarget;this.toggle(e,"false"===e.getAttribute("aria-expanded"))}handleTriggerKeyDown(t){const{key:e}=t;if(!["Enter"," ","End","Home","ArrowUp","ArrowDown"].includes(e))return;t.preventDefault(),t.stopPropagation();const i=this.triggerElements.filter(this.isFocusable),n=this.getActiveElement(),r=n instanceof HTMLElement?n:null;if(!r)return;const s=i.indexOf(r),a=i.length;let o;switch(e){case"Enter":case" ":return void r.click();case"End":o=a-1;break;case"Home":o=0;break;case"ArrowUp":o=(s-1+a)%a;break;case"ArrowDown":o=(s+1)%a}i[o].focus()}handleContentBeforeMatch(t){const e=this.triggerElements[this.contentElements.indexOf(t.currentTarget)];"true"!==e.getAttribute("aria-expanded")&&this.toggle(e,!0,!0)}open(t){this.triggerElements.includes(t)&&this.toggle(t,!0)}close(t){this.triggerElements.includes(t)&&this.toggle(t,!1)}destroy(){this.destroyed||(this.rootElement.removeAttribute("data-accordion-initialized"),this.eventController.abort(),this.destroyed=!0)}}
